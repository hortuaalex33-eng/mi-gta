<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mini Candy GOD ULTRA PRO üòà</title>

<style>
body {
  background: linear-gradient(135deg, #141e30, #243b55);
  display: flex;
  flex-direction: column;
  align-items: center;
  color: white;
  font-family: Arial;
}

#tablero {
  display: grid;
  grid-template-columns: repeat(8, 50px);
  gap: 5px;
}

.celda {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  transition: 0.3s;
}

.rojo { background:#ff4d4d; }
.azul { background:#4da6ff; }
.verde { background:#4dff88; }
.amarillo { background:#ffd24d; }
.morado { background:#b84dff; }

.bomba {
  border: 3px solid white;
}

.eliminado {
  opacity:0;
  transform: scale(0.5);
}

</style>
</head>

<body>

<h2>üç¨ Candy GOD ULTRA PRO üòà</h2>

<input id="nombre" placeholder="Tu nombre">
<button onclick="guardarJugador()">Guardar</button>

<div>
Nivel: <span id="nivel">1</span> |
Puntos: <span id="score">0</span> |
‚ù§Ô∏è <span id="vidas">5</span>
</div>

<div id="tablero"></div>

<h3>üèÜ Ranking</h3>
<div id="ranking"></div>

<script>
const colores=["rojo","azul","verde","amarillo","morado"];
const width=8;

let grid=[];
let seleccionado=null;

let score=0;
let nivel=1;
let vidas=5;
let objetivo=100;
let jugador="Anon";

function cargarDatos(){
  let data=JSON.parse(localStorage.getItem("save"));
  if(data){
    score=data.score;
    nivel=data.nivel;
    vidas=data.vidas;
    jugador=data.jugador;
  }
}

function guardarDatos(){
  localStorage.setItem("save", JSON.stringify({
    score,nivel,vidas,jugador
  }));
}

function guardarJugador(){
  jugador=document.getElementById("nombre").value || "Anon";
  guardarDatos();
}

function crearTablero(){
  tablero.innerHTML="";
  grid=[];

  for(let i=0;i<64;i++){
    let c=document.createElement("div");
    c.className="celda "+colores[Math.floor(Math.random()*colores.length)];
    c.onclick=()=>seleccionar(c);
    tablero.appendChild(c);
    grid.push(c);
  }
}

function seleccionar(c){
  if(!seleccionado){
    seleccionado=c;
  }else{
    if(esAdyacente(seleccionado,c)){
      intercambiar(seleccionado,c,true);
    }
    seleccionado=null;
  }
}

function esAdyacente(a,b){
  let ai=grid.indexOf(a);
  let bi=grid.indexOf(b);
  return [1,-1,width,-width].includes(ai-bi);
}

function intercambiar(a,b,validar=false){
  let ca=getColorClass(a);
  let cb=getColorClass(b);

  a.className="celda "+cb;
  b.className="celda "+ca;

  if(validar){
    setTimeout(()=>{
      if(!hayCombo()){
        // devolver si no hay combo
        intercambiar(a,b,false);
        vidas--;
        updateUI();
      }else{
        eliminarCombos();
      }
    },150);
  }
}

function hayCombo(){
  return buscarCombos().length>0;
}

function buscarCombos(){
  let encontrados=[];

  for(let i=0;i<64;i++){
    if(i%width<6){
      let c=getColor(i);
      if(c && c===getColor(i+1)&&c===getColor(i+2)){
        encontrados.push(i,i+1,i+2);
      }
      if(c && c===getColor(i+1)&&c===getColor(i+2)&&c===getColor(i+3)){
        grid[i].classList.add("bomba");
      }
    }

    if(i<48){
      let c=getColor(i);
      if(c && c===getColor(i+width)&&c===getColor(i+width*2)){
        encontrados.push(i,i+width,i+width*2);
      }
      if(c && c===getColor(i+width)&&c===getColor(i+width*2)&&c===getColor(i+width*3)){
        grid[i].classList.add("bomba");
      }
    }
  }

  return [...new Set(encontrados)];
}

function eliminarCombos(){
  let encontrados=buscarCombos();

  if(encontrados.length===0){
    return;
  }

  encontrados.forEach(i=>{
    if(grid[i].classList.contains("bomba")){
      explotarBomba(i);
    }
    grid[i].className="celda eliminado";
    score+=10;
  });

  if(score>=objetivo){
    nivel++;
    objetivo+=100;
  }

  guardarDatos();
  updateUI();

  setTimeout(caer,200);
}

function explotarBomba(i){
  let fila=Math.floor(i/width);
  let col=i%width;

  for(let x=0;x<width;x++){
    grid[fila*width+x].className="celda eliminado";
  }
  for(let y=0;y<width;y++){
    grid[y*width+col].className="celda eliminado";
  }
}

function caer(){
  for(let i=55;i>=0;i--){
    if(grid[i+width].classList.contains("eliminado")){
      let c=getColor(i);
      grid[i+width].className="celda "+c;
      grid[i].className="celda eliminado";
    }
  }

  for(let i=0;i<width;i++){
    if(grid[i].classList.contains("eliminado")){
      let c=colores[Math.floor(Math.random()*colores.length)];
      grid[i].className="celda "+c;
    }
  }

  setTimeout(()=>{
    if(hayCombo()){
      eliminarCombos(); // üî• combos en cadena
    }
  },200);
}

function getColor(i){
  return colores.find(c=>grid[i].classList.contains(c));
}

function getColorClass(c){
  return colores.find(x=>c.classList.contains(x));
}

function updateUI(){
  scoreEl.innerText=score;
  nivelEl.innerText=nivel;
  vidasEl.innerText=vidas;
}

function reiniciar(){
  score=0;
  nivel=1;
  vidas=5;
  crearTablero();
  guardarDatos();
}

function guardarRanking(){
  let ranking=JSON.parse(localStorage.getItem("ranking"))||[];
  ranking.push({jugador,score});
  ranking.sort((a,b)=>b.score-a.score);
  ranking=ranking.slice(0,5);
  localStorage.setItem("ranking",JSON.stringify(ranking));
  mostrarRanking();
}

function mostrarRanking(){
  let ranking=JSON.parse(localStorage.getItem("ranking"))||[];
  rankingDiv.innerHTML="";

  ranking.forEach(r=>{
    let d=document.createElement("div");
    d.innerText=r.jugador+" - "+r.score;
    rankingDiv.appendChild(d);
  });
}

// INIT
const tablero=document.getElementById("tablero");
const scoreEl=document.getElementById("score");
const nivelEl=document.getElementById("nivel");
const vidasEl=document.getElementById("vidas");
const rankingDiv=document.getElementById("ranking");

cargarDatos();
crearTablero();
updateUI();
mostrarRanking();
</script>

</body>
</html>
